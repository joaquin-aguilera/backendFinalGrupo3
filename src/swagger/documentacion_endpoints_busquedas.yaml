openapi: 3.0.0
info:
  title: API de B√∫squeda y Descubrimiento - Pulga Shop
  version: 1.0.0
  description: |
    ## Grupo 3 - Microservicio de B√∫squeda y Descubrimiento

    **Funcionalidades principales:**
    - B√∫squeda avanzada con filtros (texto, precio, categor√≠a, condici√≥n)
    - Historial de b√∫squedas por usuario
    - Registro de clicks para anal√≠tica
    - Sugerencias de b√∫squeda desde historial
    - Categor√≠as con im√°genes optimizadas

    ---
    
    ## üîó Integraciones

    ### Consumimos (APIs externas):
    - **Grupo 2 (Publicaciones):** `GET /api/publicaciones` - Productos a mostrar
    - **Grupo 4 (Autenticaci√≥n):** `GET /api/auth/me` - Validar tokens JWT

    ### Exponemos (Para otros grupos):
    - **Grupo 1 (Anal√≠tica):** `/api/analytics/searches` y `/api/analytics/clicks`
    
    ### Redireccionamos:
    - **Grupo 2 (Publicaciones):** Click en producto ‚Üí `http://localhost:4040/publicaciones/{id}`

  contact:
    name: Max Latuz
    email: max.latuz@estudiantes.uv.cl

servers:
  - url: http://localhost:5610
    description: Backend B√∫squeda (Grupo 3)

tags:
  - name: "üîç B√∫squeda"
    description: Endpoints principales de b√∫squeda de productos
  - name: "üìú Historial"
    description: Gesti√≥n del historial de b√∫squedas del usuario
  - name: "üìÅ Categor√≠as"
    description: Listado de categor√≠as y sus productos
  - name: "üìä Analytics - Grupo 1"
    description: |
      **ENDPOINTS PARA GRUPO 1 (Reportes y Anal√≠tica)**
      
      Datos en bruto para an√°lisis externo
  - name: "üìà Analytics - Interno"
    description: Estad√≠sticas y m√©tricas internas
  - name: "üñºÔ∏è Im√°genes"
    description: Servicio de im√°genes optimizadas

paths:
  # ============================================
  # ENDPOINTS PARA GRUPO 1 (ANAL√çTICA)
  # ============================================
  
  /api/analytics/searches:
    get:
      summary: Obtener todos los datos de b√∫squedas
      description: |
        **Para Grupo 1 - Reportes y Anal√≠tica**
        
        Retorna array plano con todos los registros de b√∫squedas realizadas.
      tags: ["üìä Analytics - Grupo 1"]
      responses:
        '200':
          description: Array de b√∫squedas
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    valor_busqueda:
                      type: string
                      example: "laptop gaming"
                    fecha:
                      type: string
                      format: date-time
                      example: "2025-01-15T10:30:00.000Z"

  /api/analytics/clicks:
    get:
      summary: Obtener todos los datos de clicks
      description: |
        **Para Grupo 1 - Reportes y Anal√≠tica**
        
        Retorna array plano con todos los registros de clicks en productos.
      tags: ["üìä Analytics - Grupo 1"]
      responses:
        '200':
          description: Array de clicks
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id_producto:
                      type: string
                      example: "pub_67890"
                    nombre:
                      type: string
                      example: "Laptop HP Pavilion"
                    fecha:
                      type: string
                      format: date-time
                      example: "2025-01-15T10:32:15.000Z"

  # ============================================
  # ENDPOINTS DE B√öSQUEDA
  # ============================================
  
  /api/search/products:
    get:
      summary: Buscar productos con filtros
      description: |
        B√∫squeda de productos con filtros avanzados.
        Los productos se obtienen del Grupo 2 (Publicaciones).
      tags: ["üîç B√∫squeda"]
      parameters:
        - name: busqueda
          in: query
          schema:
            type: string
          description: Texto de b√∫squeda
          example: "laptop"
        - name: precio
          in: query
          schema:
            type: string
            enum: 
              - "hasta 5000"
              - "5000-10000"
              - "10000-25000"
              - "25000-50000"
              - "50000-100000"
              - "100000-300000"
              - "300000-500000"
              - "mas de 500000"
          description: Rango de precios en CLP
        - name: categoria
          in: query
          schema:
            type: string
            enum: [ELECTR√ìNICA, ROPA, CALZADO, HOGAR, JUGUETES, DEPORTES, LIBROS, ALIMENTOS, BELLEZA, OFICINA, AUTOMOTRIZ, MASCOTAS, GENERAL]
          description: Categor√≠a del producto
        - name: condicion
          in: query
          schema:
            type: string
            enum: [NUEVO, USADO, REACONDICIONADO]
          description: Condici√≥n del producto
        - name: ordenar
          in: query
          schema:
            type: string
            enum: [precio-asc, precio-desc]
          description: Ordenamiento por precio
        - name: page
          in: query
          schema:
            type: integer
            default: 1
          description: N√∫mero de p√°gina
        - name: pageSize
          in: query
          schema:
            type: integer
            default: 20
          description: Productos por p√°gina
      responses:
        '200':
          description: Productos encontrados
          content:
            application/json:
              schema:
                type: object
                properties:
                  productos:
                    type: array
                    items:
                      $ref: '#/components/schemas/Producto'
                  metadata:
                    $ref: '#/components/schemas/PaginationMetadata'

  /api/search/products/random:
    get:
      summary: Obtener productos aleatorios
      description: Retorna productos seleccionados aleatoriamente (para "SORPR√âNDEME")
      tags: ["üîç B√∫squeda"]
      parameters:
        - name: limite
          in: query
          schema:
            type: integer
            default: 20
            maximum: 50
          description: Cantidad de productos
      responses:
        '200':
          description: Productos aleatorios
          content:
            application/json:
              schema:
                type: object
                properties:
                  productos:
                    type: array
                    items:
                      $ref: '#/components/schemas/Producto'
                  metadata:
                    type: object

  /api/search/suggestions:
    get:
      summary: Obtener sugerencias de b√∫squeda
      description: Sugerencias basadas en el historial del usuario
      tags: ["üîç B√∫squeda"]
      parameters:
        - name: texto
          in: query
          schema:
            type: string
          description: Texto para filtrar sugerencias (opcional)
      responses:
        '200':
          description: Lista de sugerencias
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Sugerencia'

  /api/search/click:
    post:
      summary: Registrar click en producto
      description: Registra cuando un usuario hace click en un producto (para anal√≠tica)
      tags: ["üîç B√∫squeda"]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id_producto, nombre]
              properties:
                id_producto:
                  type: string
                  example: "pub_123"
                nombre:
                  type: string
                  example: "Laptop HP Pavilion"
      responses:
        '200':
          description: Click registrado

  # ============================================
  # ENDPOINTS DE HISTORIAL
  # ============================================

  /api/search/history:
    get:
      summary: Obtener historial de b√∫squedas
      tags: ["üìú Historial"]
      responses:
        '200':
          description: Historial del usuario
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/HistorialBusqueda'

  /api/search/history/{id}:
    delete:
      summary: Eliminar b√∫squeda del historial
      tags: ["üìú Historial"]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: ID de la b√∫squeda a eliminar
      responses:
        '200':
          description: B√∫squeda eliminada

  # ============================================
  # ENDPOINTS DE CATEGOR√çAS
  # ============================================

  /api/categories:
    get:
      summary: Obtener todas las categor√≠as
      tags: ["üìÅ Categor√≠as"]
      responses:
        '200':
          description: Lista de categor√≠as
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'

  /api/categories/{category}/products:
    get:
      summary: Obtener productos de una categor√≠a
      tags: ["üìÅ Categor√≠as"]
      parameters:
        - name: category
          in: path
          required: true
          schema:
            type: string
          description: Nombre de la categor√≠a
          example: "ELECTR√ìNICA"
      responses:
        '200':
          description: Productos de la categor√≠a
          content:
            application/json:
              schema:
                type: object
                properties:
                  categoria:
                    type: string
                  total:
                    type: integer
                  productos:
                    type: array
                    items:
                      $ref: '#/components/schemas/Producto'

  # ============================================
  # ENDPOINTS DE ANALYTICS INTERNO
  # ============================================

  /api/analytics/top-products:
    get:
      summary: Productos m√°s clickeados
      tags: ["üìà Analytics - Interno"]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 6
      responses:
        '200':
          description: Top productos

  /api/analytics/stats:
    get:
      summary: Estad√≠sticas generales
      tags: ["üìà Analytics - Interno"]
      responses:
        '200':
          description: Estad√≠sticas de b√∫squedas

  /api/analytics/top-terms:
    get:
      summary: T√©rminos m√°s buscados
      tags: ["üìà Analytics - Interno"]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: Top t√©rminos

  /api/analytics/trends:
    get:
      summary: Tendencias de b√∫squeda
      tags: ["üìà Analytics - Interno"]
      parameters:
        - name: days
          in: query
          schema:
            type: integer
            default: 7
      responses:
        '200':
          description: Tendencias por per√≠odo

  # ============================================
  # ENDPOINTS DE IM√ÅGENES
  # ============================================

  /api/images/categories/{imageName}:
    get:
      summary: Obtener imagen de categor√≠a optimizada
      tags: ["üñºÔ∏è Im√°genes"]
      parameters:
        - name: imageName
          in: path
          required: true
          schema:
            type: string
          example: "Electronica.jpg"
        - name: width
          in: query
          schema:
            type: integer
            default: 800
        - name: height
          in: query
          schema:
            type: integer
            default: 600
      responses:
        '200':
          description: Imagen optimizada
          content:
            image/jpeg:
              schema:
                type: string
                format: binary

components:
  schemas:
    Producto:
      type: object
      properties:
        id:
          type: string
          description: ID de la publicaci√≥n
        id_producto:
          type: string
          description: ID del producto
        titulo:
          type: string
        descripcion:
          type: string
        precio:
          type: number
        categoria:
          type: string
        condicion:
          type: string
        marca:
          type: string
        imagen:
          type: string
          description: URL de la primera imagen

    PaginationMetadata:
      type: object
      properties:
        total:
          type: integer
        page:
          type: integer
        pageSize:
          type: integer
        totalPages:
          type: integer
        hasMore:
          type: boolean

    Sugerencia:
      type: object
      properties:
        id:
          type: string
          description: ID para poder eliminar del historial
        texto:
          type: string
        tipo:
          type: string
          enum: [historial, coincidencia]
        filtros:
          type: object

    HistorialBusqueda:
      type: object
      properties:
        _id:
          type: string
        queryText:
          type: string
        filters:
          type: object
        requestedAt:
          type: string
          format: date-time

    Category:
      type: object
      properties:
        nombre:
          type: string
          example: "ELECTR√ìNICA"
        imagen:
          type: string
          nullable: true
        totalProductos:
          type: integer
